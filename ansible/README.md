# Ansible Configuration Management

This directory contains Ansible playbooks and roles for configuring the AWS infrastructure and deploying the Django-PostgreSQL application to Docker Swarm.

## Structure

```
ansible/
├── inventory/
│   └── hosts.yml              # Inventory file (generated from Terraform)
├── playbooks/
│   ├── site.yml              # Main orchestration playbook
│   ├── docker-install.yml    # Docker installation
│   ├── swarm-init.yml        # Swarm cluster initialization
│   └── swarm-deploy.yml      # Application deployment
├── roles/
│   └── docker/               # Docker installation role
├── ansible.cfg               # Ansible configuration
├── generate-inventory.sh     # Script to generate inventory from Terraform
└── README.md                 # This file
```

## Prerequisites

1. **Ansible installed** (version >= 2.9):
   ```bash
   # On Ubuntu/Debian
   sudo apt update
   sudo apt install ansible
   
   # Or using pip
   pip install ansible
   ```

2. **Terraform infrastructure deployed**:
   ```bash
   cd ../terraform
   terraform apply
   ```

3. **SSH access** to the instances (private key generated by Terraform)

## Quick Start

1. **Generate inventory from Terraform outputs:**
   ```bash
   ./generate-inventory.sh
   ```

2. **Test connectivity:**
   ```bash
   ansible all -m ping
   ```

3. **Run the complete setup:**
   ```bash
   ansible-playbook playbooks/site.yml
   ```

## Playbooks

### site.yml
Main orchestration playbook that runs all other playbooks in sequence:
1. Common system updates
2. Docker installation
3. Swarm initialization
4. Application deployment

### docker-install.yml
Installs Docker and Docker Compose on all Swarm nodes:
- Removes old Docker packages
- Adds Docker repository
- Installs Docker CE and Docker Compose
- Configures Docker daemon
- Sets up firewall rules for Swarm

### swarm-init.yml
Initializes Docker Swarm cluster:
- Initializes Swarm on manager node
- Generates join tokens
- Joins worker nodes to the cluster
- Creates overlay network for applications

### swarm-deploy.yml
Deploys the Django application stack:
- Copies application files to manager node
- Builds Docker images
- Deploys stack using docker-compose.yml
- Verifies deployment and service health

## Individual Playbook Execution

You can run individual playbooks as needed:

```bash
# Install Docker only
ansible-playbook playbooks/docker-install.yml

# Initialize Swarm only
ansible-playbook playbooks/swarm-init.yml

# Deploy application only
ansible-playbook playbooks/swarm-deploy.yml
```

## Inventory Management

### Automatic Generation
The inventory is automatically generated from Terraform outputs:

```bash
./generate-inventory.sh
```

### Manual Configuration
You can also manually edit `inventory/hosts.yml` if needed:

```yaml
all:
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ../terraform/terraform-key.pem
    
  children:
    swarm_managers:
      hosts:
        swarm-manager:
          ansible_host: YOUR_MANAGER_IP
          
    swarm_workers:
      hosts:
        swarm-worker-a:
          ansible_host: YOUR_WORKER_A_IP
        swarm-worker-b:
          ansible_host: YOUR_WORKER_B_IP
```

## Configuration

### ansible.cfg
The configuration file sets:
- Default inventory location
- SSH connection settings
- Output formatting
- Fact caching

### Variables
Key variables used across playbooks:
- `docker_compose_version`: Docker Compose version to install
- `app_name`: Name of the Docker stack
- `compose_file`: Docker Compose file to use

## Roles

### docker
Reusable role for Docker installation:
- **tasks/main.yml**: Installation tasks
- **defaults/main.yml**: Default variables

## Common Tasks

### Check Swarm Status
```bash
ansible swarm_managers -m shell -a "docker node ls"
```

### Check Service Status
```bash
ansible swarm_managers -m shell -a "docker service ls"
```

### Scale Services
```bash
ansible swarm_managers -m shell -a "docker service scale myapp_web=3"
```

### View Service Logs
```bash
ansible swarm_managers -m shell -a "docker service logs myapp_web --tail 50"
```

### Update Application
```bash
# Redeploy with updated code
ansible-playbook playbooks/swarm-deploy.yml
```

## Troubleshooting

### Connection Issues
```bash
# Test SSH connectivity
ansible all -m ping

# Check SSH key permissions
chmod 600 ../terraform/terraform-key.pem

# Test with verbose output
ansible all -m ping -vvv
```

### Docker Issues
```bash
# Check Docker status on all nodes
ansible swarm_nodes -m shell -a "systemctl status docker"

# Restart Docker service
ansible swarm_nodes -m shell -a "systemctl restart docker" --become
```

### Swarm Issues
```bash
# Check Swarm status
ansible swarm_managers -m shell -a "docker info | grep Swarm"

# Leave and rejoin Swarm (workers only)
ansible swarm_workers -m shell -a "docker swarm leave"
ansible-playbook playbooks/swarm-init.yml
```

### Application Issues
```bash
# Check service status
ansible swarm_managers -m shell -a "docker service ps myapp_web"

# Check service logs
ansible swarm_managers -m shell -a "docker service logs myapp_web"

# Remove and redeploy stack
ansible swarm_managers -m shell -a "docker stack rm myapp"
ansible-playbook playbooks/swarm-deploy.yml
```

## Security Considerations

- SSH keys are managed by Terraform
- Firewall rules are configured for required ports only
- Docker daemon is configured with security best practices
- Services run with non-root users where possible

## Performance Tuning

- Docker daemon configured with appropriate log rotation
- Overlay network optimized for container communication
- Resource limits set in docker-compose.yml
- Health checks configured for all services

## Integration with CI/CD

The Ansible playbooks are designed to be called from CI/CD pipelines:

```bash
# In CI/CD pipeline
./generate-inventory.sh
ansible-playbook playbooks/site.yml --extra-vars "deploy_version=$BUILD_NUMBER"
```